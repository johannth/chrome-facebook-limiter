<html>
<head>
<script>
    var CHECK_INTERVAL = 1,
    MAX_ALLOWED_SECONDS_PER_DAY = 60 * 20,
    MAX_ALLOWED_VISITS_PER_DAY = 10;

    chrome.extension.onRequest.addListener(function(request, sender, sendResponse) 
    {
        if (request.method === "update")
        {
            sendResponse({
                "remainingSeconds": getRemainingSeconds(),
                "numberOfVisitsToday": getNumberOfVisitsToday(),
                "maxVisits": MAX_ALLOWED_VISITS_PER_DAY
            });
        }
        else if(request.method === "openTab")
        {
            markVisit();
            sendResponse({}); 
        }
        else if(request.method === "closeTab")
        {
            tabWasClosed();
            sendResponse({});
        }
    });
    
    function getNumberOfOpenTabs()
    {
        return parseInt(localStorage["numberOfOpenTabs"], 10);
    }
    
    function setNumberOfOpenTabs(numberOfOpenTabs)
    {
        localStorage["numberOfOpenTabs"] = numberOfOpenTabs;
    }
    
    function getNumberOfVisitsToday()
    {
        return parseInt(localStorage["numberOfVisitsToday"], 10);
    }
    
    function setNumberOfVisitsToday(numberOfVisitsToday)
    {
        localStorage["numberOfVisitsToday"] = numberOfVisitsToday;
    }
    
    function markVisit()
    {
        setNumberOfOpenTabs(getNumberOfOpenTabs() + 1);
        var currentTime = new Date();
        localStorage["yearOfLastVisit"] = currentTime.getFullYear();
        localStorage["monthOfLastVisit"] = currentTime.getMonth();
        localStorage["dayOfLastVisit"] = currentTime.getDate();
        setNumberOfVisitsToday(getNumberOfVisitsToday() + 1);
    }
    
    function tabWasClosed()
    {
        setNumberOfOpenTabs(getNumberOfOpenTabs() - 1);
    }

    function getRemainingSeconds()
    {    
        return parseInt(localStorage["secondsRemaining"], 10);
    }

    function setRemainingSeconds(seconds)
    {
        localStorage["secondsRemaining"] = seconds;
    }
    
    function isFirstVisitOfTheDay()
    {
        var currentTime = new Date();
        return localStorage["yearOfLastVisit"] !== "" + currentTime.getFullYear() &&
                localStorage["monthOfLastVisit"] !== "" + currentTime.getMonth() &&
                localStorage["dayOfLastVisit"] !== "" + currentTime.getDate();
    }
    
    if(localStorage["numberOfOpenTabs"] == null)
    {
        localStorage["numberOfOpenTabs"] = 0;
    }
    
    if(localStorage["numberOfVisitsToday"] == null)
    {
        localStorage["numberOfVisitsToday"] = 0;
    }
    
    if(isFirstVisitOfTheDay())
    {
        setRemainingSeconds(MAX_ALLOWED_SECONDS_PER_DAY);
        setNumberOfVisitsToday(0);
    }

    setInterval (function()
    {
        if(getNumberOfOpenTabs() > 0)
        {
            setRemainingSeconds(getRemainingSeconds() - CHECK_INTERVAL);
        }
    }, CHECK_INTERVAL * 1000);
</script>
</head>
</html>